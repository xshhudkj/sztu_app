# 播放历史点击逻辑重构任务

## 任务概述
**问题**：点击播放历史中的歌曲后，有时候播放进度条时间显示为0且无法拖动

**目标**：重新设计播放历史点击歌曲的完整逻辑链路，确保播放状态和UI显示的一致性

## 问题分析
1. **播放列表插入位置不当**：当前 `addAndPlay` 方法将歌曲添加到播放列表末尾，而非下一首位置
2. **MediaItem 数据不完整**：播放历史中的 MediaItem 可能缺少完整的 duration 信息
3. **播放器状态同步问题**：进度重置和播放器准备的时序不当，导致状态不一致
4. **进度条初始化缺陷**：当 duration 为0时，进度条的 max 值为0，导致无法拖动

## 实施计划
### 步骤1：新增 addToNextAndPlay 方法
- 文件：`PlayerController.kt`, `PlayerControllerImpl.kt`
- 功能：将歌曲插入到当前播放位置+1的位置，然后立即播放

### 步骤2：增强 MediaItem 数据验证
- 文件：`PlayerControllerImpl.kt`
- 功能：检查 MediaItem 的 duration 等关键信息，必要时从数据源补全

### 步骤3：优化播放器状态管理
- 文件：`PlayerControllerImpl.kt`
- 功能：加强播放前的状态检查，优化进度重置和播放器准备的时序

### 步骤4：修改播放历史点击逻辑
- 文件：`CurrentPlaylistFragment.kt`
- 功能：在播放历史模式下使用新的 `addToNextAndPlay` 方法

### 步骤5：优化进度条初始化
- 文件：`PlayingActivity.kt`
- 功能：加强进度条 max 值设置的有效性检查，优化错误处理

## 验证标准
1. 点击播放历史歌曲后能正常播放
2. 播放进度条显示正确的播放时间（不再显示00:00）
3. 进度条可正常拖动并准确跳转
4. 播放模式状态正确保持
5. 不影响现有其他功能的正常运行

## 实施记录
- 开始时间：2025-01-27
- 状态：进行中
- 完成步骤：任务记录文件创建
